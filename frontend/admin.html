<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fursa – Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter Tight", "sans-serif"] },
          colors: {
            brand: { 50: '#e8fef0', 500: '#1B2D21', 600: '#1B2D21', 700: '#0f1a13' },
            gray: {
              50: '#f7f8f7', 100: '#eeeeed', 200: '#d8dbd9', 300: '#c1c7c3',
              400: '#7d9187', 500: '#5a6a62', 600: '#3a4d42', 700: '#2a3930',
              800: '#1f2e24', 900: '#1B2D21',
            }
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-900">

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 sticky top-0 z-10 shadow-sm">
    <div class="max-w-screen-xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <span class="text-2xl font-bold text-brand-600 tracking-tight">Fursa</span>
      <a href="/" class="text-sm text-gray-500 hover:text-gray-900 transition-colors">← Back to jobs</a>
    </div>
  </header>

  <div class="max-w-screen-xl mx-auto px-4 py-6">

    <h1 class="text-lg font-bold text-gray-900 mb-5">Admin Overview</h1>

    <!-- Loading -->
    <div id="admin-loading" class="flex justify-center py-20">
      <div class="w-8 h-8 border-4 border-brand-500 border-t-transparent rounded-full animate-spin"></div>
    </div>

    <!-- Content -->
    <div id="admin-content" class="hidden space-y-4">

      <!-- KPI Summary -->
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
        <div class="bg-white border border-gray-200 rounded-xl p-4 text-center">
          <div id="kpi-last-run" class="text-lg font-bold text-brand-600">—</div>
          <div class="text-xs text-gray-400 mt-1">Last workflow run</div>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl p-4 text-center">
          <div id="kpi-companies" class="text-2xl font-bold text-brand-600">—</div>
          <div class="text-xs text-gray-400 mt-1">Companies in DB</div>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl p-4 text-center">
          <div id="kpi-with-url" class="text-2xl font-bold text-brand-600">—</div>
          <div class="text-xs text-gray-400 mt-1">With career URL</div>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl p-4 text-center">
          <div id="kpi-vacancies" class="text-2xl font-bold text-brand-600">—</div>
          <div class="text-xs text-gray-400 mt-1">Vacancies found</div>
        </div>
      </div>

      <!-- Row 1: Scraper + DB -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

        <div class="bg-white border border-gray-200 rounded-xl p-5">
          <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">Scraper Status</h2>
          <div id="card-scraper" class="space-y-2.5"></div>
        </div>

        <div class="bg-white border border-gray-200 rounded-xl p-5">
          <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">Database</h2>
          <div id="card-database" class="space-y-2.5"></div>
        </div>

      </div>

      <!-- Row 2: By Source (full width) -->
      <div class="bg-white border border-gray-200 rounded-xl p-5">
        <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">By Source</h2>
        <div id="card-source" class="divide-y divide-gray-50"></div>
      </div>

      <!-- Row 3: By Region + Top Locations -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

        <div class="bg-white border border-gray-200 rounded-xl p-5">
          <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">By Continent</h2>
          <div id="card-geo" class="divide-y divide-gray-50"></div>
        </div>

        <div class="bg-white border border-gray-200 rounded-xl p-5">
          <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">Top Locations</h2>
          <div id="card-locations" class="divide-y divide-gray-50"></div>
        </div>

      </div>

      <!-- Row 4: Companies List -->
      <div class="bg-white border border-gray-200 rounded-xl p-5">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
          <div class="flex items-center gap-3">
            <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider">
              Companies <span id="companies-count" class="text-gray-300"></span>
            </h2>
            <button onclick="exportExcel()"
              class="text-xs font-medium bg-brand-500 text-white px-3 py-1 rounded-lg hover:bg-brand-700 transition-colors">
              Export Excel
            </button>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <input id="co-search" type="text" placeholder="Search by name…"
              class="text-sm border border-gray-200 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-brand-500 w-44" />
            <select id="co-vertical"
              class="text-sm border border-gray-200 rounded-lg px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-brand-500">
              <option value="">All verticals</option>
              <option value="saas">SaaS</option><option value="fintech">Fintech</option>
              <option value="ai">AI</option><option value="data">Data</option>
              <option value="devtools">DevTools</option><option value="security">Security</option>
              <option value="marketplace">Marketplace</option><option value="consumer">Consumer</option>
              <option value="healthcare">Healthcare</option><option value="hr">HR</option>
              <option value="ecommerce">E-commerce</option><option value="logistics">Logistics</option>
            </select>
            <select id="co-geo"
              class="text-sm border border-gray-200 rounded-lg px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-brand-500">
              <option value="">All geo</option>
              <option value="US">US</option><option value="EU">EU</option>
              <option value="UK">UK</option><option value="GLOBAL">Global</option>
              <option value="APAC">APAC</option><option value="LATAM">LATAM</option>
            </select>
            <select id="co-url"
              class="text-sm border border-gray-200 rounded-lg px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-brand-500">
              <option value="">All</option>
              <option value="true">Has URL</option>
              <option value="false">No URL</option>
            </select>
          </div>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-gray-100 text-left text-xs text-gray-400 uppercase tracking-wider">
                <th class="py-2 pr-3">Name</th>
                <th class="py-2 pr-3">Vertical</th>
                <th class="py-2 pr-3">Geo</th>
                <th class="py-2 pr-3">Career URL</th>
                <th class="py-2 pr-3">Last Scraped</th>
                <th class="py-2 pr-3 text-right">Jobs</th>
                <th class="py-2 text-right">Status</th>
              </tr>
            </thead>
            <tbody id="co-tbody" class="divide-y divide-gray-50"></tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="flex items-center justify-between mt-4 pt-3 border-t border-gray-100">
          <button id="co-prev" onclick="coNav(-1)"
            class="text-sm text-gray-500 hover:text-gray-900 disabled:opacity-30 disabled:cursor-default">← Prev</button>
          <span id="co-page-info" class="text-xs text-gray-400"></span>
          <button id="co-next" onclick="coNav(1)"
            class="text-sm text-gray-500 hover:text-gray-900 disabled:opacity-30 disabled:cursor-default">Next →</button>
        </div>
      </div>

    </div>

    <!-- Error -->
    <div id="admin-error" class="hidden text-center py-20 text-red-400 text-sm"></div>

  </div>

  <script>window.__API_KEY__ = "{{ api_key }}";</script>
  <script>
    const API_KEY = window.__API_KEY__ || "dev-insecure-key";

    const SOURCE_LABELS = { custom: "LLM (Custom)" };

    const CONTINENT_ORDER = [
      "North America", "Europe", "Asia", "South America",
      "Oceania", "Africa", "Remote", "Antarctica", "Other",
    ];

    // ── Helpers ────────────────────────────────────────────────────────────────

    function timeSince(iso) {
      if (!iso) return "—";
      const diff = Date.now() - new Date(iso).getTime();
      const m = Math.floor(diff / 60000);
      const h = Math.floor(m / 60);
      const d = Math.floor(h / 24);
      if (d > 0) return `${d}d ago`;
      if (h > 0) return `${h}h ago`;
      return m > 0 ? `${m}m ago` : "just now";
    }

    function fmtDatetime(iso) {
      if (!iso) return "—";
      return new Date(iso).toLocaleString("en-GB", {
        day: "numeric", month: "short", year: "numeric",
        hour: "2-digit", minute: "2-digit", timeZoneName: "short",
      });
    }

    function esc(str) {
      return String(str || "")
        .replace(/&/g, "&amp;").replace(/</g, "&lt;")
        .replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    function parseCronHuman(cron) {
      if (!cron) return cron;
      const parts = cron.split(" ");
      if (parts.length === 5 && parts[2] === "*" && parts[3] === "*" && parts[4] === "*") {
        const min = parts[0].padStart(2, "0");
        const hours = parts[1].split(",").map(h => h.padStart(2, "0") + ":" + min);
        return hours.length === 1
          ? `Daily at ${hours[0]} UTC`
          : hours.join(" / ") + " UTC";
      }
      return cron;
    }

    function truncUrl(url, max) {
      if (!url) return "";
      return url.length > max ? url.slice(0, max) + "…" : url;
    }

    // ── Render helpers ─────────────────────────────────────────────────────────

    function statRow(label, value, note) {
      return `
        <div class="flex items-baseline justify-between gap-2">
          <span class="text-sm text-gray-500">${label}</span>
          <span class="text-sm font-semibold text-gray-900 text-right">
            ${value}${note ? `<span class="text-xs font-normal text-gray-400 ml-1">${note}</span>` : ""}
          </span>
        </div>`;
    }

    function heroStat(number, label) {
      return `
        <div class="flex items-end gap-2 mb-4 pb-4 border-b border-gray-100">
          <span class="text-4xl font-bold text-brand-600 leading-none">${esc(String(number))}</span>
          <span class="text-sm text-gray-400 pb-0.5">${esc(label)}</span>
        </div>`;
    }

    function barRow(label, count, maxCount, total) {
      const barPct   = maxCount > 0 ? (count / maxCount * 100).toFixed(1) : 0;
      const sharePct = total > 0 ? (count / total * 100).toFixed(1) : "0.0";
      const dimmed   = count === 0 ? " opacity-40" : "";
      return `
        <div class="flex items-center gap-3 py-2${dimmed}">
          <span class="text-sm text-gray-700 shrink-0" style="min-width:150px">${esc(label)}</span>
          <div class="flex-1 bg-gray-100 rounded-full h-1.5">
            <div class="bg-brand-500 rounded-full h-1.5" style="width:${barPct}%"></div>
          </div>
          <span class="text-sm font-medium text-gray-900 shrink-0 text-right" style="min-width:48px">${count.toLocaleString()}</span>
          <span class="text-xs text-gray-400 shrink-0 text-right" style="min-width:38px">${sharePct}%</span>
        </div>`;
    }

    function locRow(name, count) {
      return `
        <div class="flex items-center justify-between gap-3 py-2">
          <span class="text-sm text-gray-700 truncate">${esc(name)}</span>
          <span class="text-sm font-medium text-gray-900 shrink-0">${count.toLocaleString()}</span>
        </div>`;
    }

    // ── Load admin stats ────────────────────────────────────────────────────────

    async function loadAdmin() {
      try {
        const res = await fetch("/api/stats/admin", { headers: { "X-API-Key": API_KEY } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const d = await res.json();

        // Scraper Status
        document.getElementById("card-scraper").innerHTML =
          heroStat(`${d.runs_per_day}×`, "runs / day") +
          [
            statRow("Schedule",           parseCronHuman(d.schedule_cron)),
            statRow("Last run",           timeSince(d.last_run)),
            statRow("Last run (exact)",   fmtDatetime(d.last_run)),
            statRow("Added in last 24 h", `+${d.new_24h.toLocaleString()}`),
            statRow("Companies total",    d.total_companies.toLocaleString()),
            statRow("With career URL",    d.companies_with_url.toLocaleString()),
            statRow("Due for scraping",   d.companies_due.toLocaleString()),
          ].join("");

        // Database
        document.getElementById("card-database").innerHTML = [
          statRow("Active jobs",        d.total_jobs.toLocaleString()),
          statRow("Added in last 24 h", `+${d.new_24h.toLocaleString()}`),
        ].join("");

        // By Source
        const srcEntries = Object.entries(d.by_source).sort((a, b) => b[1] - a[1]);
        const srcTotal   = srcEntries.reduce((s, [, v]) => s + v, 0);
        const srcMax     = Math.max(...srcEntries.map(([, v]) => v), 1);
        document.getElementById("card-source").innerHTML =
          srcEntries.map(([src, cnt]) =>
            barRow(SOURCE_LABELS[src] || src, cnt, srcMax, srcTotal)
          ).join("");

        // By Continent
        const contData   = d.by_continent || {};
        const contTotal  = Object.values(contData).reduce((s, v) => s + v, 0);
        const contMax    = Math.max(...Object.values(contData), 1);
        const contRows   = CONTINENT_ORDER
          .map(name => [name, contData[name] || 0])
          .filter(([, v], i) => v > 0 || i < 7);
        document.getElementById("card-geo").innerHTML =
          contRows.map(([name, cnt]) =>
            barRow(name, cnt, contMax, contTotal)
          ).join("");

        // Top Locations
        document.getElementById("card-locations").innerHTML =
          d.top_locations.length
            ? d.top_locations.map(loc => locRow(loc.name, loc.count)).join("")
            : `<p class="text-sm text-gray-400 py-4 text-center">No data yet</p>`;

        // KPI summary
        document.getElementById("kpi-last-run").textContent = timeSince(d.last_run);
        document.getElementById("kpi-last-run").title = fmtDatetime(d.last_run);
        document.getElementById("kpi-companies").textContent = d.total_companies.toLocaleString();
        document.getElementById("kpi-with-url").textContent = d.companies_with_url.toLocaleString();
        document.getElementById("kpi-vacancies").textContent = d.total_active.toLocaleString();

        document.getElementById("admin-loading").classList.add("hidden");
        document.getElementById("admin-content").classList.remove("hidden");

        // Load companies table after stats
        loadCompanies();

      } catch (err) {
        document.getElementById("admin-loading").classList.add("hidden");
        const el = document.getElementById("admin-error");
        el.textContent = `Failed to load admin stats: ${err.message}`;
        el.classList.remove("hidden");
      }
    }

    // ── Companies table ──────────────────────────────────────────────────────

    let coPage = 1;
    const CO_LIMIT = 50;
    let coDebounce = null;

    function coFilters() {
      const params = new URLSearchParams();
      params.set("page", coPage);
      params.set("limit", CO_LIMIT);
      const search = document.getElementById("co-search").value.trim();
      if (search) params.set("search", search);
      const vertical = document.getElementById("co-vertical").value;
      if (vertical) params.set("vertical", vertical);
      const geo = document.getElementById("co-geo").value;
      if (geo) params.set("geo", geo);
      const hasUrl = document.getElementById("co-url").value;
      if (hasUrl) params.set("has_url", hasUrl);
      return params.toString();
    }

    async function loadCompanies() {
      try {
        const res = await fetch(`/api/companies?${coFilters()}`, { headers: { "X-API-Key": API_KEY } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const d = await res.json();

        document.getElementById("companies-count").textContent = `(${d.total})`;

        const tbody = document.getElementById("co-tbody");
        if (d.items.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7" class="py-8 text-center text-gray-400 text-sm">No companies found</td></tr>`;
        } else {
          tbody.innerHTML = d.items.map(c => `
            <tr class="${c.is_enabled ? '' : 'opacity-50'}">
              <td class="py-2.5 pr-3 font-medium text-gray-900">${esc(c.name)}</td>
              <td class="py-2.5 pr-3 text-gray-500">${esc(c.vertical || '—')}</td>
              <td class="py-2.5 pr-3 text-gray-500">${esc(c.geo_primary || '—')}</td>
              <td class="py-2.5 pr-3 text-gray-500 truncate max-w-[200px]" title="${esc(c.career_url || '')}">
                ${c.career_url ? `<a href="${esc(c.career_url)}" target="_blank" rel="noopener" class="text-brand-500 hover:underline">${esc(truncUrl(c.career_url, 35))}</a>` : '<span class="text-gray-300">not set</span>'}
              </td>
              <td class="py-2.5 pr-3 text-gray-500">${timeSince(c.last_scraped)}</td>
              <td class="py-2.5 pr-3 text-right tabular-nums font-medium">${c.active_jobs}</td>
              <td class="py-2.5 text-right">
                <span class="inline-block px-2 py-0.5 text-xs rounded-full ${c.is_enabled ? 'bg-green-50 text-green-700' : 'bg-gray-100 text-gray-400'}">
                  ${c.is_enabled ? 'active' : 'disabled'}
                </span>
              </td>
            </tr>
          `).join("");
        }

        // Pagination
        document.getElementById("co-page-info").textContent = `Page ${d.page} of ${d.pages}`;
        document.getElementById("co-prev").disabled = d.page <= 1;
        document.getElementById("co-next").disabled = d.page >= d.pages;

      } catch (err) {
        document.getElementById("co-tbody").innerHTML =
          `<tr><td colspan="7" class="py-8 text-center text-red-400 text-sm">Error: ${esc(err.message)}</td></tr>`;
      }
    }

    function coNav(dir) {
      coPage = Math.max(1, coPage + dir);
      loadCompanies();
    }

    // Filter change handlers
    document.getElementById("co-search").addEventListener("input", () => {
      clearTimeout(coDebounce);
      coDebounce = setTimeout(() => { coPage = 1; loadCompanies(); }, 300);
    });
    document.getElementById("co-vertical").addEventListener("change", () => { coPage = 1; loadCompanies(); });
    document.getElementById("co-geo").addEventListener("change", () => { coPage = 1; loadCompanies(); });
    document.getElementById("co-url").addEventListener("change", () => { coPage = 1; loadCompanies(); });

    // ── Excel export ──────────────────────────────────────────────────────────
    async function exportExcel() {
      try {
        const res = await fetch("/api/companies/export", { headers: { "X-API-Key": API_KEY } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "fursa_companies.xlsx";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        alert("Export failed: " + err.message);
      }
    }

    // ── Init ──────────────────────────────────────────────────────────────────
    loadAdmin();
  </script>
</body>
</html>
