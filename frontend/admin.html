<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>else | Admin</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ccircle cx='8' cy='8' r='8' fill='%230C1422'/%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@400;500;600;700&family=Lora:ital@1&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter Tight", "sans-serif"] },
          colors: {
            brand: { 50: '#E4EBF8', 500: '#0C1422', 600: '#0C1422', 700: '#070D18' },
            gray: {
              50: '#f7f8f7', 100: '#eeeeed', 200: '#d8dbd9', 300: '#c1c7c3',
              400: '#7d9187', 500: '#5a6a62', 600: '#3a4d42', 700: '#2a3930',
              800: '#1f2e24', 900: '#0C1422',
            }
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-900">

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 sticky top-0 z-10 shadow-sm">
    <div class="max-w-screen-xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <a href="/" class="text-2xl text-brand-600 hover:opacity-70 transition-opacity" style="font-family:'Lora',serif;font-style:italic;">else</a>
      <div class="flex items-center gap-3">
        <a href="/career-discovery" class="text-sm font-medium bg-brand-500 text-white px-3 py-1.5 rounded-lg hover:bg-brand-700 transition-colors">Career Discovery</a>
        <a href="/" class="text-sm text-gray-500 hover:text-gray-900 transition-colors">← Back to jobs</a>
      </div>
    </div>
  </header>

  <div class="max-w-screen-xl mx-auto px-4 py-6">

    <h1 class="text-lg font-bold text-gray-900 mb-5">Admin Overview</h1>

    <!-- Loading -->
    <div id="admin-loading" class="flex justify-center py-20">
      <div class="w-8 h-8 border-4 border-brand-500 border-t-transparent rounded-full animate-spin"></div>
    </div>

    <!-- Content -->
    <div id="admin-content" class="hidden space-y-4">

      <!-- KPI Summary -->
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
        <div class="bg-white border border-gray-200 rounded-xl p-4 text-center">
          <div id="kpi-last-run" class="text-lg font-bold text-brand-600">—</div>
          <div class="text-xs text-gray-400 mt-1">Last workflow run</div>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl p-4 text-center">
          <div id="kpi-companies" class="text-2xl font-bold text-brand-600">—</div>
          <div class="text-xs text-gray-400 mt-1">Companies in DB</div>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl p-4 text-center">
          <div id="kpi-with-url" class="text-2xl font-bold text-brand-600">—</div>
          <div class="text-xs text-gray-400 mt-1">With career URL</div>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl p-4 text-center">
          <div id="kpi-vacancies" class="text-2xl font-bold text-brand-600">—</div>
          <div class="text-xs text-gray-400 mt-1">Vacancies found</div>
        </div>
      </div>

      <!-- Row 1: Scraper + DB -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

        <div class="bg-white border border-gray-200 rounded-xl p-5">
          <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">Scraper Status</h2>
          <div id="card-scraper" class="space-y-2.5"></div>
        </div>

        <div class="bg-white border border-gray-200 rounded-xl p-5">
          <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">Database</h2>
          <div id="card-database" class="space-y-2.5"></div>
        </div>

      </div>

      <!-- Row 2: By Source (full width) -->
      <div class="bg-white border border-gray-200 rounded-xl p-5">
        <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">By Source</h2>
        <div id="card-source" class="divide-y divide-gray-50"></div>
      </div>

      <!-- Row 3: By Region + Top Locations -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

        <div class="bg-white border border-gray-200 rounded-xl p-5">
          <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">By Continent</h2>
          <div id="card-geo" class="divide-y divide-gray-50"></div>
        </div>

        <div class="bg-white border border-gray-200 rounded-xl p-5">
          <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">Top Locations</h2>
          <div id="card-locations" class="divide-y divide-gray-50"></div>
        </div>

      </div>

      <!-- Row 4: Companies List -->
      <div class="bg-white border border-gray-200 rounded-xl p-5">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
          <div class="flex items-center gap-3">
            <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider">
              Companies <span id="companies-count" class="text-gray-300"></span>
            </h2>
            <div class="flex items-center gap-2">
              <button onclick="exportExcel()"
                class="text-xs font-medium bg-brand-500 text-white px-3 py-1 rounded-lg hover:bg-brand-700 transition-colors">
                Export Excel
              </button>
              <button onclick="document.getElementById('import-file-input').click()"
                class="text-xs font-medium bg-gray-600 text-white px-3 py-1 rounded-lg hover:bg-gray-500 transition-colors">
                Import Excel
              </button>
              <input id="import-file-input" type="file" accept=".xlsx,.xls" class="hidden"
                onchange="importExcel(this)">
              <span id="import-status" class="text-xs text-gray-400 hidden"></span>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <input id="co-search" type="text" placeholder="Search by name…"
              class="text-sm border border-gray-200 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-brand-500 w-44" />
            <select id="co-vertical"
              class="text-sm border border-gray-200 rounded-lg px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-brand-500">
              <option value="">All verticals</option>
              <option value="saas">SaaS</option><option value="fintech">Fintech</option>
              <option value="ai">AI</option><option value="data">Data</option>
              <option value="devtools">DevTools</option><option value="security">Security</option>
              <option value="marketplace">Marketplace</option><option value="consumer">Consumer</option>
              <option value="healthcare">Healthcare</option><option value="hr">HR</option>
              <option value="ecommerce">E-commerce</option><option value="logistics">Logistics</option>
            </select>
            <select id="co-url"
              class="text-sm border border-gray-200 rounded-lg px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-brand-500">
              <option value="">All</option>
              <option value="true">Has URL</option>
              <option value="false">No URL</option>
            </select>
          </div>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-gray-100 text-left text-xs text-gray-400 uppercase tracking-wider">
                <th class="py-2 pr-3 cursor-pointer select-none hover:text-gray-600" onclick="coSortBy('name')">
                  Name <span id="sort-name-icon" class="ml-0.5">⇅</span>
                </th>
                <th class="py-2 pr-3">Vertical</th>
                <th class="py-2 pr-3">Website</th>
                <th class="py-2 pr-3">Career URL</th>
                <th class="py-2 pr-3 cursor-pointer select-none hover:text-gray-600" onclick="coSortBy('last_scraped')">
                  Last Scraped <span id="sort-last_scraped-icon" class="ml-0.5">⇅</span>
                </th>
                <th class="py-2 pr-3 cursor-pointer select-none hover:text-gray-600" onclick="coSortBy('scrape_status')">
                  Status <span id="sort-scrape_status-icon" class="ml-0.5">⇅</span>
                </th>
                <th class="py-2 text-center">Jobs</th>
                <th class="py-2 w-6"></th>
              </tr>
            </thead>
            <tbody id="co-tbody" class="divide-y divide-gray-50"></tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="flex items-center justify-center gap-1 mt-4 pt-3 border-t border-gray-100">
          <button id="co-prev" onclick="coNav(-1)"
            class="w-7 h-7 flex items-center justify-center rounded text-gray-400 hover:text-gray-900 hover:bg-gray-100 disabled:opacity-30 disabled:cursor-default transition-colors">←</button>
          <div id="co-page-info" class="flex items-center gap-1"></div>
          <button id="co-next" onclick="coNav(1)"
            class="w-7 h-7 flex items-center justify-center rounded text-gray-400 hover:text-gray-900 hover:bg-gray-100 disabled:opacity-30 disabled:cursor-default transition-colors">→</button>
        </div>
      </div>

    </div>

    <!-- Error -->
    <div id="admin-error" class="hidden text-center py-20 text-red-400 text-sm"></div>

  </div>

  <!-- Edit Company Modal -->
  <div id="edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 p-6">
      <div class="flex items-center justify-between mb-5">
        <h3 class="text-sm font-semibold text-gray-800 truncate" id="edit-modal-title"></h3>
        <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600 text-lg leading-none">✕</button>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Website URL</label>
          <input id="edit-website-url" type="url" placeholder="https://example.com"
            class="w-full text-sm border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-500" />
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Career URL</label>
          <input id="edit-career-url" type="url" placeholder="https://example.com/careers"
            class="w-full text-sm border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-500" />
          <p class="text-xs text-gray-400 mt-1">Leave blank to trigger auto-discovery on next run.</p>
        </div>
        <div class="flex items-center gap-2">
          <input id="edit-enabled" type="checkbox" class="rounded border-gray-300 text-brand-500 focus:ring-brand-500" />
          <label for="edit-enabled" class="text-sm text-gray-600">Enabled</label>
        </div>
      </div>
      <p id="edit-modal-error" class="text-xs text-red-500 mt-3 min-h-[1rem]"></p>
      <div class="flex justify-end gap-2 mt-5">
        <button onclick="closeEditModal()"
          class="text-sm px-4 py-2 rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50 transition-colors">Cancel</button>
        <button id="edit-save-btn" onclick="saveCompany()"
          class="text-sm px-4 py-2 rounded-lg bg-brand-500 text-white hover:bg-brand-700 transition-colors disabled:opacity-50">Save</button>
      </div>
    </div>
  </div>

  <script>window.__API_KEY__ = "{{ api_key }}";</script>
  <script>
    const API_KEY = window.__API_KEY__ || "dev-insecure-key";

    const SOURCE_LABELS = { custom: "Else Agent" };

    function capFirst(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }

    // ── Helpers ────────────────────────────────────────────────────────────────

    function timeSince(iso) {
      if (!iso) return "—";
      const diff = Date.now() - new Date(iso).getTime();
      const m = Math.floor(diff / 60000);
      const h = Math.floor(m / 60);
      const d = Math.floor(h / 24);
      if (d > 0) return `${d}d ago`;
      if (h > 0) return `${h}h ago`;
      return m > 0 ? `${m}m ago` : "just now";
    }

    function fmtDatetime(iso) {
      if (!iso) return "—";
      return new Date(iso).toLocaleString("en-GB", {
        day: "numeric", month: "short", year: "numeric",
        hour: "2-digit", minute: "2-digit", timeZoneName: "short",
      });
    }

    function esc(str) {
      return String(str || "")
        .replace(/&/g, "&amp;").replace(/</g, "&lt;")
        .replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    function parseCronHuman(cron) {
      if (!cron) return cron;
      const parts = cron.split(" ");
      if (parts.length === 5 && parts[2] === "*" && parts[3] === "*" && parts[4] === "*") {
        const min = parts[0].padStart(2, "0");
        const hours = parts[1].split(",").map(h => h.padStart(2, "0") + ":" + min);
        return hours.length === 1
          ? `Daily at ${hours[0]} UTC`
          : hours.join(" / ") + " UTC";
      }
      return cron;
    }

    function truncUrl(url, max) {
      if (!url) return "";
      return url.length > max ? url.slice(0, max) + "…" : url;
    }

    function scrapeStatusBadge(status) {
      if (!status) return '<span class="text-gray-300">—</span>';
      const cfg = {
        OK:           ["#16a34a", "OK"],
        HTTP_ERROR:   ["#dc2626", "HTTP error"],
        TIMEOUT:      ["#dc2626", "Timeout"],
        EMPTY:        ["#d97706", "Empty"],
        SPA_DETECTED: ["#d97706", "SPA"],
      };
      const [color, label] = cfg[status] || ["#6b7280", status];
      return `<span class="text-xs font-medium" style="color:${color}">${label}</span>`;
    }

    // ── Render helpers ─────────────────────────────────────────────────────────

    function statRow(label, value, note) {
      return `
        <div class="flex items-baseline justify-between gap-2">
          <span class="text-sm text-gray-500">${label}</span>
          <span class="text-sm font-semibold text-gray-900 text-right">
            ${value}${note ? `<span class="text-xs font-normal text-gray-400 ml-1">${note}</span>` : ""}
          </span>
        </div>`;
    }

    function heroStat(number, label) {
      return `
        <div class="flex items-end gap-2 mb-4 pb-4 border-b border-gray-100">
          <span class="text-4xl font-bold text-brand-600 leading-none">${esc(String(number))}</span>
          <span class="text-sm text-gray-400 pb-0.5">${esc(label)}</span>
        </div>`;
    }

    function barRow(label, count, maxCount, total) {
      const barPct   = maxCount > 0 ? (count / maxCount * 100).toFixed(1) : 0;
      const sharePct = total > 0 ? (count / total * 100).toFixed(1) : "0.0";
      const dimmed   = count === 0 ? " opacity-40" : "";
      return `
        <div class="flex items-center gap-3 py-2${dimmed}">
          <span class="text-sm text-gray-700 shrink-0" style="min-width:150px">${esc(label)}</span>
          <div class="flex-1 bg-gray-100 rounded-full h-1.5">
            <div class="bg-brand-500 rounded-full h-1.5" style="width:${barPct}%"></div>
          </div>
          <span class="text-sm font-medium text-gray-900 shrink-0 text-right" style="min-width:48px">${count.toLocaleString()}</span>
          <span class="text-xs text-gray-400 shrink-0 text-right" style="min-width:38px">${sharePct}%</span>
        </div>`;
    }

    function locRow(name, count) {
      return `
        <div class="flex items-center justify-between gap-3 py-2">
          <span class="text-sm text-gray-700 truncate">${esc(name)}</span>
          <span class="text-sm font-medium text-gray-900 shrink-0">${count.toLocaleString()}</span>
        </div>`;
    }

    // ── Load admin stats ────────────────────────────────────────────────────────

    async function loadAdmin() {
      try {
        const res = await fetch("/api/stats/admin", { headers: { "X-API-Key": API_KEY } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const d = await res.json();

        // Scraper Status
        document.getElementById("card-scraper").innerHTML =
          heroStat(`${d.runs_per_day}×`, "runs / day") +
          [
            statRow("Schedule",           parseCronHuman(d.schedule_cron)),
            statRow("Last run",           timeSince(d.last_run)),
            statRow("Last run (exact)",   fmtDatetime(d.last_run)),
            statRow("Added in last 24 h", `+${d.new_24h.toLocaleString()}`),
            statRow("Companies total",    d.total_companies.toLocaleString()),
            statRow("With website URL",   (d.companies_with_website || 0).toLocaleString()),
            statRow("With career URL",    d.companies_with_url.toLocaleString()),
            statRow("Due for scraping",   d.companies_due.toLocaleString()),
            ...(d.scrape_health ? Object.entries(d.scrape_health).map(([k, v]) =>
              statRow(`Scrape: ${k}`, v.toLocaleString())
            ) : []),
          ].join("");

        // Database
        document.getElementById("card-database").innerHTML = [
          statRow("Active jobs",        d.total_jobs.toLocaleString()),
          statRow("Added in last 24 h", `+${d.new_24h.toLocaleString()}`),
        ].join("");

        // By Source
        const srcEntries = Object.entries(d.by_source).sort((a, b) => b[1] - a[1]);
        const srcTotal   = srcEntries.reduce((s, [, v]) => s + v, 0);
        const srcMax     = Math.max(...srcEntries.map(([, v]) => v), 1);
        document.getElementById("card-source").innerHTML =
          srcEntries.map(([src, cnt]) =>
            barRow(src in SOURCE_LABELS ? SOURCE_LABELS[src] : capFirst(src), cnt, srcMax, srcTotal)
          ).join("");

        // By Continent
        const contData   = d.by_continent || {};
        const contTotal  = Object.values(contData).reduce((s, v) => s + v, 0);
        const contRows   = Object.entries(contData).sort((a, b) => b[1] - a[1]);
        const contMax    = contRows.length ? contRows[0][1] : 1;
        document.getElementById("card-geo").innerHTML =
          contRows.map(([name, cnt]) =>
            barRow(name, cnt, contMax, contTotal)
          ).join("");

        // Top Locations
        document.getElementById("card-locations").innerHTML =
          d.top_locations.length
            ? d.top_locations.map(loc => locRow(loc.name, loc.count)).join("")
            : `<p class="text-sm text-gray-400 py-4 text-center">No data yet</p>`;

        // KPI summary
        document.getElementById("kpi-last-run").textContent = timeSince(d.last_run);
        document.getElementById("kpi-last-run").title = fmtDatetime(d.last_run);
        document.getElementById("kpi-companies").textContent = d.total_companies.toLocaleString();
        document.getElementById("kpi-with-url").textContent = d.companies_with_url.toLocaleString();
        document.getElementById("kpi-vacancies").textContent = d.total_active.toLocaleString();

        document.getElementById("admin-loading").classList.add("hidden");
        document.getElementById("admin-content").classList.remove("hidden");

        // Load companies table after stats
        loadCompanies();

      } catch (err) {
        document.getElementById("admin-loading").classList.add("hidden");
        const el = document.getElementById("admin-error");
        el.textContent = `Failed to load admin stats: ${err.message}`;
        el.classList.remove("hidden");
      }
    }

    // ── Companies table ──────────────────────────────────────────────────────

    let coPage = 1;
    const CO_LIMIT = 50;
    let coDebounce = null;
    let coSort = "name_asc";

    function coFilters() {
      const params = new URLSearchParams();
      params.set("page", coPage);
      params.set("limit", CO_LIMIT);
      const search = document.getElementById("co-search").value.trim();
      if (search) params.set("search", search);
      const vertical = document.getElementById("co-vertical").value;
      if (vertical) params.set("vertical", vertical);
      const hasUrl = document.getElementById("co-url").value;
      if (hasUrl) params.set("has_url", hasUrl);
      if (coSort) params.set("sort", coSort);
      params.set("enabled", "true");
      return params.toString();
    }

    function coGoTo(page) {
      coPage = page;
      loadCompanies();
    }

    function renderPagination(cur, total) {
      if (total <= 1) return "";
      const items = [];
      if (total <= 7) {
        for (let i = 1; i <= total; i++) items.push(i);
      } else {
        items.push(1);
        if (cur > 3) items.push("…");
        for (let i = Math.max(2, cur - 1); i <= Math.min(total - 1, cur + 1); i++) items.push(i);
        if (cur < total - 2) items.push("…");
        items.push(total);
      }
      return items.map(p => {
        if (p === "…") return `<span class="text-xs text-gray-400 px-0.5 select-none">…</span>`;
        const active = p === cur;
        return `<button onclick="coGoTo(${p})" class="text-xs w-7 h-7 rounded flex items-center justify-center transition-colors ${active ? 'bg-brand-500 text-white font-semibold' : 'text-gray-500 hover:bg-gray-100'}">${p}</button>`;
      }).join("");
    }

    function coSortBy(field) {
      const ascKey = field + "_asc";
      const descKey = field + "_desc";
      coSort = coSort === ascKey ? descKey : ascKey;
      coPage = 1;
      updateSortIcons();
      loadCompanies();
    }

    function updateSortIcons() {
      ["name", "last_scraped", "scrape_status"].forEach(f => {
        const el = document.getElementById(`sort-${f}-icon`);
        if (!el) return;
        if (coSort === f + "_asc") el.textContent = "↑";
        else if (coSort === f + "_desc") el.textContent = "↓";
        else el.textContent = "⇅";
      });
    }

    async function loadCompanies() {
      try {
        const res = await fetch(`/api/companies?${coFilters()}`, { headers: { "X-API-Key": API_KEY } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const d = await res.json();

        document.getElementById("companies-count").textContent = `(${d.total})`;

        const tbody = document.getElementById("co-tbody");
        if (d.items.length === 0) {
          tbody.innerHTML = `<tr><td colspan="8" class="py-8 text-center text-gray-400 text-sm">No companies found</td></tr>`;
        } else {
          tbody.innerHTML = d.items.map(c => {
            const verticalDisplay = c.vertical
              ? c.vertical.charAt(0).toUpperCase() + c.vertical.slice(1)
              : '—';
            return `
            <tr class="${c.is_enabled ? '' : 'opacity-50'}">
              <td class="py-2.5 pr-3 font-medium text-gray-900">${esc(c.name)}</td>
              <td class="py-2.5 pr-3 text-gray-500">${esc(verticalDisplay)}</td>
              <td class="py-2.5 pr-3 text-gray-500 truncate max-w-[140px]" title="${esc(c.website_url || '')}">
                ${c.website_url ? `<a href="${esc(c.website_url)}" target="_blank" rel="noopener" class="text-blue-500 hover:underline">${esc(truncUrl(c.website_url, 25))}</a>` : '<span class="text-gray-300">—</span>'}
              </td>
              <td class="py-2.5 pr-3 text-gray-500 truncate max-w-[200px]" title="${esc(c.career_url || '')}">
                ${c.career_url ? `<a href="${esc(c.career_url)}" target="_blank" rel="noopener" class="text-brand-500 hover:underline">${esc(truncUrl(c.career_url, 30))}</a>` : '<span class="text-gray-300">not set</span>'}
              </td>
              <td class="py-2.5 pr-3 text-gray-500">${timeSince(c.last_scraped)}</td>
              <td class="py-2.5 pr-3">${scrapeStatusBadge(c.scrape_status)}</td>
              <td class="py-2.5 text-center tabular-nums font-medium">${c.active_jobs}</td>
              <td class="py-2.5 pl-2">
                <button onclick="openEditModal(${JSON.stringify(c).replace(/"/g, '&quot;')})"
                  class="text-gray-500 hover:text-gray-800 transition-colors" title="Edit">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="15" height="15">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                </button>
              </td>
            </tr>
          `}).join("");
        }

        // Pagination
        document.getElementById("co-page-info").innerHTML = renderPagination(d.page, d.pages);
        document.getElementById("co-prev").disabled = d.page <= 1;
        document.getElementById("co-next").disabled = d.page >= d.pages;

      } catch (err) {
        document.getElementById("co-tbody").innerHTML =
          `<tr><td colspan="8" class="py-8 text-center text-red-400 text-sm">Error: ${esc(err.message)}</td></tr>`;
      }
    }

    function coNav(dir) {
      coPage = Math.max(1, coPage + dir);
      loadCompanies();
    }

    // Filter change handlers
    document.getElementById("co-search").addEventListener("input", () => {
      clearTimeout(coDebounce);
      coDebounce = setTimeout(() => { coPage = 1; loadCompanies(); }, 300);
    });
    document.getElementById("co-vertical").addEventListener("change", () => { coPage = 1; loadCompanies(); });
    document.getElementById("co-url").addEventListener("change", () => { coPage = 1; loadCompanies(); });

    // ── Excel export ──────────────────────────────────────────────────────────
    async function exportExcel() {
      try {
        const res = await fetch("/api/companies/export", { headers: { "X-API-Key": API_KEY } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "fursa_companies.xlsx";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        alert("Export failed: " + err.message);
      }
    }

    // ── Excel import ──────────────────────────────────────────────────────────
    async function importExcel(input) {
      const file = input.files[0];
      if (!file) return;
      input.value = "";                        // reset so same file can be re-selected

      const status = document.getElementById("import-status");
      status.textContent = "Uploading…";
      status.className = "text-xs text-gray-400";
      status.classList.remove("hidden");

      const formData = new FormData();
      formData.append("file", file);

      try {
        const res = await fetch("/api/companies/import", {
          method: "POST",
          headers: { "X-API-Key": API_KEY },
          body: formData,
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || `HTTP ${res.status}`);

        const parts = [`✓ ${data.updated} updated`, `${data.deleted} deleted`];
        if (data.not_found?.length) parts.push(`${data.not_found.length} not found`);
        status.textContent = parts.join(" · ");
        status.className = "text-xs text-green-400";

        loadCompanies();   // refresh table
        if (data.not_found?.length) {
          console.warn("Companies not found in DB:", data.not_found);
        }
      } catch (err) {
        status.textContent = "Import failed: " + err.message;
        status.className = "text-xs text-red-400";
      }
    }

    // ── Edit modal ────────────────────────────────────────────────────────────

    let _editCompanyId = null;

    function openEditModal(c) {
      _editCompanyId = c.id;
      document.getElementById("edit-modal-title").textContent = c.name;
      document.getElementById("edit-website-url").value = c.website_url || "";
      document.getElementById("edit-career-url").value = c.career_url || "";
      document.getElementById("edit-enabled").checked = c.is_enabled;
      document.getElementById("edit-modal-error").textContent = "";
      document.getElementById("edit-modal").classList.remove("hidden");
    }

    function closeEditModal() {
      document.getElementById("edit-modal").classList.add("hidden");
      _editCompanyId = null;
    }

    async function saveCompany() {
      if (!_editCompanyId) return;
      const btn = document.getElementById("edit-save-btn");
      btn.disabled = true;
      btn.textContent = "Saving…";

      const payload = {
        website_url: document.getElementById("edit-website-url").value.trim() || null,
        career_url: document.getElementById("edit-career-url").value.trim() || null,
        is_enabled: document.getElementById("edit-enabled").checked,
      };

      try {
        const res = await fetch(`/api/companies/${_editCompanyId}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json", "X-API-Key": API_KEY },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({ detail: res.statusText }));
          throw new Error(err.detail || `HTTP ${res.status}`);
        }
        closeEditModal();
        loadCompanies();
      } catch (err) {
        document.getElementById("edit-modal-error").textContent = err.message;
      } finally {
        btn.disabled = false;
        btn.textContent = "Save";
      }
    }

    // Close modal on backdrop click
    document.getElementById("edit-modal").addEventListener("click", function(e) {
      if (e.target === this) closeEditModal();
    });

    // ── Init ──────────────────────────────────────────────────────────────────
    loadAdmin();
  </script>
</body>
</html>
