name: Deploy to Hetzner
# Secrets configured - deploy ready

on:
  workflow_dispatch:
  push:
    branches:
      - 'claude/x-verified-followers-agent-6ncTJ'
    paths:
      - '.github/workflows/deploy.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      HETZNER_TOKEN: ${{ secrets.HETZNER_API_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Delete existing servers
        run: |
          echo "Checking for existing servers..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "Authorization: Bearer $HETZNER_TOKEN" \
            https://api.hetzner.cloud/v1/servers)
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo "HTTP status: $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: Hetzner API returned $HTTP_CODE"
            echo "Response: $BODY"
            echo "Check that HETZNER_API_TOKEN secret is correct."
            exit 1
          fi
          echo "$BODY" | python3 << 'PYSCRIPT'
          import json, sys, subprocess, os
          raw = sys.stdin.read().strip()
          if not raw:
              print("No response from API, skipping cleanup.")
              sys.exit(0)
          data = json.loads(raw)
          token = os.environ["HETZNER_TOKEN"]
          for s in data.get("servers", []):
              print(f"Deleting server {s['name']} (ID: {s['id']})...")
              subprocess.run(["curl", "-s", "-X", "DELETE",
                  "-H", f"Authorization: Bearer {token}",
                  f"https://api.hetzner.cloud/v1/servers/{s['id']}"])
          if not data.get("servers"):
              print("No existing servers found.")
          PYSCRIPT
          sleep 5

      - name: Create server
        run: |
          python3 << 'PYSCRIPT'
          import json, subprocess, os, textwrap

          token = os.environ["HETZNER_TOKEN"]
          x_user = "${{ secrets.X_USERNAME }}"
          x_email = "${{ secrets.X_EMAIL }}"
          x_pass = "${{ secrets.X_PASSWORD }}"
          branch = "claude/x-verified-followers-agent-6ncTJ"

          cloud_init = textwrap.dedent(f"""\
          #cloud-config
          package_update: true
          packages:
            - python3
            - python3-pip
            - python3-venv
            - git
            - xvfb
            - libnss3
            - libatk1.0-0
            - libatk-bridge2.0-0
            - libcups2
            - libdrm2
            - libxkbcommon0
            - libxcomposite1
            - libxdamage1
            - libxrandr2
            - libgbm1
            - libpango-1.0-0
            - libcairo2
            - libasound2t64
            - libxshmfence1
            - fonts-liberation
            - libgl1
            - libpangocairo-1.0-0
            - libglib2.0-0
            - libx11-xcb1

          write_files:
            - path: /root/.env-bot
              permissions: "0600"
              content: |
                X_USERNAME={x_user}
                X_EMAIL={x_email}
                X_PASSWORD={x_pass}

            - path: /root/setup-bot.sh
              permissions: "0755"
              content: |
                #!/bin/bash
                set -e
                exec > /var/log/bot-setup.log 2>&1
                echo "=== Bot Setup Started $(date) ==="
                git clone -b {branch} https://github.com/Aletunzi/SatoraXagent.git /root/SatoraXagent
                cd /root/SatoraXagent
                mkdir -p data
                cp /root/.env-bot .env
                python3 -m venv venv
                source venv/bin/activate
                pip install -r requirements.txt
                playwright install chromium
                playwright install-deps chromium || true
                bash scripts/setup-server.sh
                systemctl start satora-bot
                echo "=== Bot Setup Complete $(date) ==="

          runcmd:
            - bash /root/setup-bot.sh
          """)

          payload = {
              "name": "satora-bot",
              "server_type": "cpx11",
              "image": "ubuntu-24.04",
              "location": "nbg1",
              "user_data": cloud_init,
              "public_net": {"enable_ipv4": True, "enable_ipv6": True},
              "start_after_create": True
          }

          result = subprocess.run(
              ["curl", "-s", "-X", "POST",
               "https://api.hetzner.cloud/v1/servers",
               "-H", f"Authorization: Bearer {token}",
               "-H", "Content-Type: application/json",
               "-d", json.dumps(payload)],
              capture_output=True, text=True)

          data = json.loads(result.stdout)
          if "server" in data:
              s = data["server"]
              ip = s["public_net"]["ipv4"]["ip"]
              print(f"Server created!")
              print(f"  Name: {s['name']}")
              print(f"  ID: {s['id']}")
              print(f"  IP: {ip}")
              print(f"  Dashboard: http://{ip}:5000/")
              print(f"  Screenshots: http://{ip}:8080/")
              open("/tmp/server_ip.txt", "w").write(ip)
          else:
              print("ERROR:", json.dumps(data, indent=2))
              exit(1)
          PYSCRIPT

      - name: Wait and verify
        run: |
          IP=$(cat /tmp/server_ip.txt)
          echo "Waiting 5 min for cloud-init to finish..."
          sleep 300
          echo ""
          echo "========================================="
          echo "  DEPLOYMENT COMPLETE"
          echo "  IP: $IP"
          echo "  Dashboard: http://$IP:5000/"
          echo "  Screenshots: http://$IP:8080/"
          echo "========================================="
