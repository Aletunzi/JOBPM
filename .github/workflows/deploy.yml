name: Deploy to Hetzner
# Secrets configured - deploy ready

on:
  workflow_dispatch:
  push:
    branches:
      - 'claude/x-verified-followers-agent-6ncTJ'
    paths:
      - '.github/workflows/deploy.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      HETZNER_TOKEN: ${{ secrets.HETZNER_API_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Delete existing servers
        run: |
          echo "Checking for existing servers..."
          BODY=$(curl -sf -H "Authorization: Bearer $HETZNER_TOKEN" \
            https://api.hetzner.cloud/v1/servers) || {
            echo "ERROR: Hetzner API call failed. Check HETZNER_API_TOKEN."
            exit 1
          }

          # Parse server IDs and delete them
          SERVERS=$(echo "$BODY" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for s in data.get('servers', []):
              print(f\"{s['id']} {s['name']}\")
          ")

          if [ -z "$SERVERS" ]; then
            echo "No existing servers found."
          else
            echo "$SERVERS" | while read -r SID SNAME; do
              echo "Deleting server $SNAME (ID: $SID)..."
              curl -sf -X DELETE \
                -H "Authorization: Bearer $HETZNER_TOKEN" \
                "https://api.hetzner.cloud/v1/servers/$SID"
              echo "  Deleted."
            done
            echo "Waiting for servers to be fully removed..."
            sleep 10
          fi

      - name: Create server
        run: |
          python3 << 'PYSCRIPT'
          import json, subprocess, os, textwrap

          token = os.environ["HETZNER_TOKEN"]
          x_user = "${{ secrets.X_USERNAME }}"
          x_email = "${{ secrets.X_EMAIL }}"
          x_pass = "${{ secrets.X_PASSWORD }}"
          webhook_secret = "${{ secrets.WEBHOOK_SECRET }}"
          branch = "claude/x-verified-followers-agent-6ncTJ"

          cloud_init = textwrap.dedent(f"""\
          #cloud-config
          package_update: true
          packages:
            - python3
            - python3-pip
            - python3-venv
            - git
            - xvfb
            - libnss3
            - libatk1.0-0
            - libatk-bridge2.0-0
            - libcups2
            - libdrm2
            - libxkbcommon0
            - libxcomposite1
            - libxdamage1
            - libxrandr2
            - libgbm1
            - libpango-1.0-0
            - libcairo2
            - libasound2t64
            - libxshmfence1
            - fonts-liberation
            - libgl1
            - libpangocairo-1.0-0
            - libglib2.0-0
            - libx11-xcb1

          write_files:
            - path: /root/.env-bot
              permissions: "0600"
              content: |
                X_USERNAME={x_user}
                X_EMAIL={x_email}
                X_PASSWORD={x_pass}
                WEBHOOK_SECRET={webhook_secret}

            - path: /root/setup-bot.sh
              permissions: "0755"
              content: |
                #!/bin/bash
                set -e
                exec > /var/log/bot-setup.log 2>&1
                echo "=== Bot Setup Started $(date) ==="
                git clone -b {branch} https://github.com/Aletunzi/SatoraXagent.git /root/SatoraXagent
                cd /root/SatoraXagent
                mkdir -p data
                cp /root/.env-bot .env
                python3 -m venv venv
                source venv/bin/activate
                pip install -r requirements.txt
                playwright install chromium
                playwright install-deps chromium || true
                bash scripts/setup-server.sh
                systemctl start satora-bot
                echo "=== Bot Setup Complete $(date) ==="

          runcmd:
            - bash /root/setup-bot.sh
          """)

          payload = {
              "name": "satora-bot",
              "server_type": "cax11",
              "image": "ubuntu-24.04",
              "location": "nbg1",
              "user_data": cloud_init,
              "public_net": {"enable_ipv4": True, "enable_ipv6": True},
              "start_after_create": True
          }

          result = subprocess.run(
              ["curl", "-s", "-X", "POST",
               "https://api.hetzner.cloud/v1/servers",
               "-H", f"Authorization: Bearer {token}",
               "-H", "Content-Type: application/json",
               "-d", json.dumps(payload)],
              capture_output=True, text=True)

          data = json.loads(result.stdout)
          if "server" in data:
              s = data["server"]
              ip = s["public_net"]["ipv4"]["ip"]
              print(f"Server created!")
              print(f"  Name: {s['name']}")
              print(f"  ID: {s['id']}")
              print(f"  IP: {ip}")
              print(f"  Dashboard: http://{ip}:5000/")
              print(f"  Screenshots: http://{ip}:8080/")
              open("/tmp/server_ip.txt", "w").write(ip)
          else:
              print("ERROR:", json.dumps(data, indent=2))
              exit(1)
          PYSCRIPT

      - name: Wait for health check
        run: |
          IP=$(cat /tmp/server_ip.txt)
          echo "Waiting for dashboard to come up at http://$IP:5000/api/health ..."
          for i in $(seq 1 40); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://$IP:5000/api/health" 2>/dev/null || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo ""
              echo "Dashboard is up! (attempt $i)"
              HEALTH=$(curl -s "http://$IP:5000/api/health")
              echo "Health response: $HEALTH"
              echo ""
              echo "========================================="
              echo "  DEPLOYMENT COMPLETE"
              echo "  IP: $IP"
              echo "  Dashboard: http://$IP:5000/"
              echo "  Screenshots: http://$IP:8080/"
              echo "========================================="
              exit 0
            fi
            echo "  Attempt $i/40 â€” not ready yet (HTTP $STATUS), waiting 15s..."
            sleep 15
          done
          echo "ERROR: Dashboard did not come up within 10 minutes."
          exit 1
