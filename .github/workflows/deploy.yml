name: Deploy to Hetzner

on:
  workflow_dispatch:
  push:
    branches:
      - 'claude/x-verified-followers-agent-6ncTJ'
    paths:
      - '.github/workflows/deploy.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      HETZNER_TOKEN: ${{ secrets.HETZNER_API_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate SSH key
        run: |
          ssh-keygen -t ed25519 -f /tmp/deploy_key -N "" -q
          chmod 600 /tmp/deploy_key
          echo "SSH key generated."

      - name: Check for existing server
        id: check_server
        run: |
          BODY=$(curl -sf -H "Authorization: Bearer $HETZNER_TOKEN" \
            https://api.hetzner.cloud/v1/servers) || {
            echo "ERROR: Hetzner API call failed."
            exit 1
          }

          SERVER_INFO=$(echo "$BODY" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for s in data.get('servers', []):
              if s['name'] == 'satora-bot':
                  ip = s['public_net']['ipv4']['ip']
                  print(f\"{s['id']} {ip}\")
                  break
          ")

          if [ -n "$SERVER_INFO" ]; then
            SID=$(echo "$SERVER_INFO" | cut -d' ' -f1)
            SIP=$(echo "$SERVER_INFO" | cut -d' ' -f2)
            echo "server_exists=true" >> $GITHUB_OUTPUT
            echo "server_id=$SID" >> $GITHUB_OUTPUT
            echo "server_ip=$SIP" >> $GITHUB_OUTPUT
            echo "$SIP" > /tmp/server_ip.txt
            echo "Found existing server: ID=$SID IP=$SIP"
          else
            echo "server_exists=false" >> $GITHUB_OUTPUT
            echo "No existing server found — will create one."
          fi

      # ─── PATH A: Server exists → just update ───
      - name: Update existing server
        if: steps.check_server.outputs.server_exists == 'true'
        run: |
          IP=${{ steps.check_server.outputs.server_ip }}
          echo "Updating server at $IP ..."

          # Wait for SSH to be available
          for i in $(seq 1 10); do
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i /tmp/deploy_key root@$IP "echo ok" 2>/dev/null && break
            echo "  SSH not ready (attempt $i/10), waiting 5s..."
            sleep 5
          done

          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i /tmp/deploy_key root@$IP << 'REMOTE'
          set -e
          cd /root/SatoraXagent
          echo "=== Manual deploy $(date) ==="

          # Pull latest code
          git fetch origin
          git reset --hard origin/claude/x-verified-followers-agent-6ncTJ

          # Update dependencies if requirements changed
          source venv/bin/activate
          pip install -q -r requirements.txt

          # Restart services
          systemctl restart satora-dashboard.service
          systemctl restart satora-bot.service

          echo "=== Deploy complete $(date) ==="
          REMOTE

          echo ""
          echo "========================================="
          echo "  UPDATE COMPLETE"
          echo "  IP: $IP"
          echo "  Dashboard: http://$IP:5000/"
          echo "  Screenshots: http://$IP:8080/"
          echo "========================================="

      # ─── PATH B: No server → create from scratch ───
      - name: Create new server
        if: steps.check_server.outputs.server_exists == 'false'
        run: |
          python3 << 'PYSCRIPT'
          import json, subprocess, os, textwrap

          token = os.environ["HETZNER_TOKEN"]
          x_user = "${{ secrets.X_USERNAME }}"
          x_email = "${{ secrets.X_EMAIL }}"
          x_pass = "${{ secrets.X_PASSWORD }}"
          webhook_secret = "${{ secrets.WEBHOOK_SECRET }}"
          branch = "claude/x-verified-followers-agent-6ncTJ"

          with open("/tmp/deploy_key.pub") as f:
              ssh_pubkey = f.read().strip()

          cloud_init = textwrap.dedent(f"""\
          #cloud-config
          package_update: true
          packages:
            - python3
            - python3-pip
            - python3-venv
            - git
            - xvfb
            - libnss3
            - libatk1.0-0
            - libatk-bridge2.0-0
            - libcups2
            - libdrm2
            - libxkbcommon0
            - libxcomposite1
            - libxdamage1
            - libxrandr2
            - libgbm1
            - libpango-1.0-0
            - libcairo2
            - libasound2t64
            - libxshmfence1
            - fonts-liberation
            - libgl1
            - libpangocairo-1.0-0
            - libglib2.0-0
            - libx11-xcb1

          ssh_authorized_keys:
            - {ssh_pubkey}

          write_files:
            - path: /root/.env-bot
              permissions: "0600"
              content: |
                X_USERNAME={x_user}
                X_EMAIL={x_email}
                X_PASSWORD={x_pass}
                WEBHOOK_SECRET={webhook_secret}

            - path: /root/setup-bot.sh
              permissions: "0755"
              content: |
                #!/bin/bash
                set -e
                exec > /var/log/bot-setup.log 2>&1
                echo "=== Bot Setup Started $(date) ==="
                echo "[1/7] Cloning repository..."
                git clone -b {branch} https://github.com/Aletunzi/SatoraXagent.git /root/SatoraXagent
                cd /root/SatoraXagent
                mkdir -p data
                cp /root/.env-bot .env
                echo "[2/7] Creating virtualenv..."
                python3 -m venv venv
                source venv/bin/activate
                echo "[3/7] Installing pip dependencies..."
                pip install -r requirements.txt
                echo "[4/7] Installing Playwright chromium..."
                playwright install chromium
                echo "[5/7] Installing Playwright system deps..."
                playwright install-deps chromium || true
                echo "[6/7] Running setup-server.sh..."
                bash scripts/setup-server.sh
                echo "[7/7] Starting bot service..."
                systemctl start satora-bot
                echo "=== Bot Setup Complete $(date) ==="

          runcmd:
            - bash /root/setup-bot.sh
          """)

          payload = {
              "name": "satora-bot",
              "server_type": "cax11",
              "image": "ubuntu-24.04",
              "location": "nbg1",
              "user_data": cloud_init,
              "public_net": {"enable_ipv4": True, "enable_ipv6": True},
              "start_after_create": True
          }

          result = subprocess.run(
              ["curl", "-s", "-X", "POST",
               "https://api.hetzner.cloud/v1/servers",
               "-H", f"Authorization: Bearer {token}",
               "-H", "Content-Type: application/json",
               "-d", json.dumps(payload)],
              capture_output=True, text=True)

          data = json.loads(result.stdout)
          if "server" in data:
              s = data["server"]
              ip = s["public_net"]["ipv4"]["ip"]
              print(f"Server created!")
              print(f"  Name: {s['name']}")
              print(f"  ID: {s['id']}")
              print(f"  IP: {ip}")
              print(f"  Dashboard: http://{ip}:5000/")
              print(f"  Screenshots: http://{ip}:8080/")
              open("/tmp/server_ip.txt", "w").write(ip)
          else:
              print("ERROR:", json.dumps(data, indent=2))
              exit(1)
          PYSCRIPT

      - name: Wait for health check (new server only)
        if: steps.check_server.outputs.server_exists == 'false'
        run: |
          IP=$(cat /tmp/server_ip.txt)
          echo "Waiting for dashboard to come up at http://$IP:5000/api/health ..."
          echo "Will try up to 60 attempts (15 minutes)..."
          echo ""

          for i in $(seq 1 60); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://$IP:5000/api/health" 2>/dev/null) || HTTP_CODE="000"
            if [ "$HTTP_CODE" = "200" ]; then
              echo ""
              echo "Dashboard is up! (attempt $i)"
              HEALTH=$(curl -s "http://$IP:5000/api/health")
              echo "Health response: $HEALTH"
              echo ""
              echo "========================================="
              echo "  DEPLOYMENT COMPLETE"
              echo "  IP: $IP"
              echo "  Dashboard: http://$IP:5000/"
              echo "  Screenshots: http://$IP:8080/"
              echo "========================================="
              exit 0
            fi

            # Every 10 attempts, SSH in and show progress
            if [ $((i % 10)) -eq 0 ]; then
              echo ""
              echo "--- SSH progress check (attempt $i) ---"
              ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i /tmp/deploy_key root@$IP \
                "tail -5 /var/log/bot-setup.log 2>/dev/null || echo 'Setup log not available yet'; \
                 cloud-init status 2>/dev/null || true" 2>/dev/null || echo "(SSH not ready yet)"
              echo "---"
              echo ""
            fi

            echo "  Attempt $i/60 — HTTP $HTTP_CODE, waiting 15s..."
            sleep 15
          done

          echo ""
          echo "ERROR: Dashboard did not come up within 15 minutes."
          exit 1

      - name: Diagnose failure
        if: failure()
        run: |
          IP=$(cat /tmp/server_ip.txt 2>/dev/null) || { echo "No server IP found."; exit 0; }
          echo "========================================="
          echo "  DEPLOYMENT FAILED — DIAGNOSTICS"
          echo "  Server IP: $IP"
          echo "========================================="
          echo ""

          SSH_CMD="ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i /tmp/deploy_key root@$IP"

          echo "=== cloud-init status ==="
          $SSH_CMD "cloud-init status --long" 2>/dev/null || echo "(Could not connect via SSH)"
          echo ""

          echo "=== Bot setup log ==="
          $SSH_CMD "cat /var/log/bot-setup.log" 2>/dev/null || echo "(Log not available)"
          echo ""

          echo "=== cloud-init output log (last 50 lines) ==="
          $SSH_CMD "tail -50 /var/log/cloud-init-output.log" 2>/dev/null || echo "(Log not available)"
          echo ""

          echo "=== systemctl status satora-dashboard ==="
          $SSH_CMD "systemctl status satora-dashboard" 2>/dev/null || echo "(Service not found)"
          echo ""

          echo "=== journalctl satora-dashboard (last 30 lines) ==="
          $SSH_CMD "journalctl -u satora-dashboard --no-pager -n 30" 2>/dev/null || echo "(No logs)"
          echo ""

          echo "=== systemctl status satora-bot ==="
          $SSH_CMD "systemctl status satora-bot" 2>/dev/null || echo "(Service not found)"
          echo ""

          echo "=== Listening ports ==="
          $SSH_CMD "ss -tlnp" 2>/dev/null || echo "(Could not check)"
