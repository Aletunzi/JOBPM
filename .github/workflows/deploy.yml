name: Deploy to Hetzner

on:
  workflow_dispatch:
  push:
    branches:
      - 'claude/x-verified-followers-agent-6ncTJ'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      HETZNER_TOKEN: ${{ secrets.HETZNER_API_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate and register SSH key
        run: |
          # Generate ephemeral key
          ssh-keygen -t ed25519 -f /tmp/deploy_key -N "" -q
          chmod 600 /tmp/deploy_key

          # Delete any leftover deploy key from previous runs
          EXISTING=$(curl -sf -H "Authorization: Bearer $HETZNER_TOKEN" \
            https://api.hetzner.cloud/v1/ssh_keys | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for k in data.get('ssh_keys', []):
              if k['name'] == 'deploy-tmp':
                  print(k['id'])
          " 2>/dev/null || true)

          if [ -n "$EXISTING" ]; then
            echo "Removing old deploy-tmp key (ID: $EXISTING)..."
            curl -sf -X DELETE \
              -H "Authorization: Bearer $HETZNER_TOKEN" \
              "https://api.hetzner.cloud/v1/ssh_keys/$EXISTING" || true
          fi

          # Register new key via Hetzner API
          PUBKEY=$(cat /tmp/deploy_key.pub)
          RESULT=$(curl -sf -X POST \
            -H "Authorization: Bearer $HETZNER_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"name\": \"deploy-tmp\", \"public_key\": \"$PUBKEY\"}" \
            https://api.hetzner.cloud/v1/ssh_keys) || {
            echo "ERROR: Failed to register SSH key."
            exit 1
          }

          SSH_KEY_ID=$(echo "$RESULT" | python3 -c "import json,sys; print(json.load(sys.stdin)['ssh_key']['id'])")
          echo "SSH key registered: ID=$SSH_KEY_ID"
          echo "$SSH_KEY_ID" > /tmp/ssh_key_id.txt

      - name: Check for existing server
        id: check_server
        run: |
          BODY=$(curl -sf -H "Authorization: Bearer $HETZNER_TOKEN" \
            https://api.hetzner.cloud/v1/servers) || {
            echo "ERROR: Hetzner API call failed."
            exit 1
          }

          SERVER_INFO=$(echo "$BODY" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for s in data.get('servers', []):
              if s['name'] == 'satora-bot':
                  ip = s['public_net']['ipv4']['ip']
                  print(f\"{s['id']} {ip}\")
                  break
          ")

          if [ -n "$SERVER_INFO" ]; then
            SID=$(echo "$SERVER_INFO" | cut -d' ' -f1)
            SIP=$(echo "$SERVER_INFO" | cut -d' ' -f2)
            echo "Found existing server: ID=$SID IP=$SIP"

            # Check if it's healthy
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://$SIP:5000/api/health" 2>/dev/null) || HTTP_CODE="000"

            if [ "$HTTP_CODE" = "200" ]; then
              echo "server_status=healthy" >> $GITHUB_OUTPUT
              echo "server_ip=$SIP" >> $GITHUB_OUTPUT
              echo "Server is healthy! Auto-deploy timer will handle code updates."
            else
              echo "server_status=broken" >> $GITHUB_OUTPUT
              echo "server_id=$SID" >> $GITHUB_OUTPUT
              echo "Server is NOT healthy (HTTP $HTTP_CODE). Will delete and recreate."
            fi
          else
            echo "server_status=none" >> $GITHUB_OUTPUT
            echo "No existing server found."
          fi

      - name: Update secrets on healthy server
        if: steps.check_server.outputs.server_status == 'healthy'
        env:
          X_EMAIL: ${{ secrets.X_EMAIL }}
          X_PASSWORD: ${{ secrets.X_PASSWORD }}
          WEBHOOK_SECRET_OLD: ${{ secrets.WEBHOOK_SECRET_OLD }}
          WEBHOOK_SECRET_NEW: ${{ secrets.WEBHOOK_SECRET }}
          BRANCH: claude/x-verified-followers-agent-6ncTJ
        run: |
          IP=${{ steps.check_server.outputs.server_ip }}
          SSH_CMD="ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i /tmp/deploy_key root@$IP"

          echo "Server is healthy — updating secrets via API..."

          # Try API first
          AUTH_SECRET="${WEBHOOK_SECRET_OLD:-$WEBHOOK_SECRET_NEW}"
          API_OK=false

          RESPONSE=$(curl -sf -X POST "http://$IP:5000/api/update-env" \
            -H "Content-Type: application/json" \
            -H "X-Webhook-Secret: $AUTH_SECRET" \
            -d "{
              \"X_EMAIL\": \"${X_EMAIL}\",
              \"X_PASSWORD\": \"${X_PASSWORD}\",
              \"WEBHOOK_SECRET\": \"${WEBHOOK_SECRET_NEW}\"
            }") && API_OK=true || true

          if [ "$API_OK" = "true" ]; then
            echo "API response: $RESPONSE"
            echo "========================================="
            echo "  SECRETS UPDATED via API"
            echo "  IP: $IP"
            echo "  Dashboard: http://$IP:5000/"
            echo "  Screenshots: http://$IP:8080/"
            echo "========================================="
          else
            echo "API update failed — falling back to SSH..."
            echo ""

            # 1. Pull latest code on server
            echo "--- Pulling latest code via SSH ---"
            $SSH_CMD "cd /root/SatoraXagent && git fetch origin $BRANCH && git reset --hard origin/$BRANCH" || {
              echo "ERROR: SSH git pull failed."
              exit 1
            }

            # 2. Update secrets directly in .env-bot
            echo "--- Updating secrets in .env-bot ---"
            $SSH_CMD "sed -i 's/^X_EMAIL=.*/X_EMAIL=${X_EMAIL}/' /root/.env-bot && \
              sed -i 's/^X_PASSWORD=.*/X_PASSWORD=${X_PASSWORD}/' /root/.env-bot && \
              sed -i 's/^WEBHOOK_SECRET=.*/WEBHOOK_SECRET=${WEBHOOK_SECRET_NEW}/' /root/.env-bot"

            # 3. Update pip deps if needed
            $SSH_CMD "cd /root/SatoraXagent && source venv/bin/activate && pip install -q -r requirements.txt" || true

            # 4. Restart services
            echo "--- Restarting services ---"
            $SSH_CMD "systemctl restart satora-dashboard && systemctl restart satora-bot"

            echo ""
            echo "========================================="
            echo "  SECRETS UPDATED via SSH fallback"
            echo "  IP: $IP"
            echo "  Dashboard: http://$IP:5000/"
            echo "  Screenshots: http://$IP:8080/"
            echo "========================================="
          fi

      - name: Broken server detected
        if: steps.check_server.outputs.server_status == 'broken'
        run: |
          SID=${{ steps.check_server.outputs.server_id }}
          echo "========================================="
          echo "  SERVER IS BROKEN (ID=$SID)"
          echo "  Dashboard is not responding."
          echo ""
          echo "  To fix: delete the server manually from"
          echo "  Hetzner console, then re-run this workflow."
          echo "========================================="
          exit 1

      - name: Create new server
        if: steps.check_server.outputs.server_status == 'none'
        run: |
          python3 << 'PYSCRIPT'
          import json, subprocess, os, textwrap

          token = os.environ["HETZNER_TOKEN"]
          x_user = "${{ secrets.X_USERNAME }}"
          x_email = "${{ secrets.X_EMAIL }}"
          x_pass = "${{ secrets.X_PASSWORD }}"
          webhook_secret = "${{ secrets.WEBHOOK_SECRET }}"
          branch = "claude/x-verified-followers-agent-6ncTJ"

          with open("/tmp/ssh_key_id.txt") as f:
              ssh_key_id = int(f.read().strip())

          with open("/tmp/deploy_key.pub") as f:
              ssh_pubkey = f.read().strip()

          cloud_init = textwrap.dedent(f"""\
          #cloud-config
          package_update: true
          packages:
            - python3
            - python3-pip
            - python3-venv
            - git
            - xvfb
            - libnss3
            - libatk1.0-0
            - libatk-bridge2.0-0
            - libcups2
            - libdrm2
            - libxkbcommon0
            - libxcomposite1
            - libxdamage1
            - libxrandr2
            - libgbm1
            - libpango-1.0-0
            - libcairo2
            - libasound2t64
            - libxshmfence1
            - fonts-liberation
            - libgl1
            - libpangocairo-1.0-0
            - libglib2.0-0
            - libx11-xcb1

          ssh_authorized_keys:
            - {ssh_pubkey}

          write_files:
            - path: /root/.env-bot
              permissions: "0600"
              content: |
                X_USERNAME={x_user}
                X_EMAIL={x_email}
                X_PASSWORD={x_pass}
                WEBHOOK_SECRET={webhook_secret}

            - path: /root/setup-bot.sh
              permissions: "0755"
              content: |
                #!/bin/bash
                set -e
                exec > /var/log/bot-setup.log 2>&1
                echo "=== Bot Setup Started ==="
                date
                echo "[1/7] Cloning repository..."
                git clone -b {branch} https://github.com/Aletunzi/SatoraXagent.git /root/SatoraXagent
                cd /root/SatoraXagent
                mkdir -p data
                cp /root/.env-bot .env
                echo "[2/7] Creating virtualenv..."
                python3 -m venv venv
                source venv/bin/activate
                echo "[3/7] Installing pip dependencies..."
                pip install -r requirements.txt
                echo "[4/7] Installing Playwright chromium..."
                playwright install chromium
                echo "[5/7] Installing Playwright system deps..."
                playwright install-deps chromium || true
                echo "[6/7] Running setup-server.sh..."
                bash scripts/setup-server.sh
                echo "[7/7] Starting bot service..."
                systemctl start satora-bot
                echo "=== Bot Setup Complete ==="
                date

          runcmd:
            - bash /root/setup-bot.sh
          """)

          payload = {
              "name": "satora-bot",
              "server_type": "cax11",
              "image": "ubuntu-24.04",
              "location": "nbg1",
              "user_data": cloud_init,
              "ssh_keys": [ssh_key_id],
              "public_net": {"enable_ipv4": True, "enable_ipv6": True},
              "start_after_create": True
          }

          result = subprocess.run(
              ["curl", "-s", "-X", "POST",
               "https://api.hetzner.cloud/v1/servers",
               "-H", f"Authorization: Bearer {token}",
               "-H", "Content-Type: application/json",
               "-d", json.dumps(payload)],
              capture_output=True, text=True)

          data = json.loads(result.stdout)
          if "server" in data:
              s = data["server"]
              ip = s["public_net"]["ipv4"]["ip"]
              print(f"Server created!")
              print(f"  Name: {s['name']}")
              print(f"  ID: {s['id']}")
              print(f"  IP: {ip}")
              print(f"  Dashboard: http://{ip}:5000/")
              print(f"  Screenshots: http://{ip}:8080/")
              open("/tmp/server_ip.txt", "w").write(ip)
          else:
              print("ERROR:", json.dumps(data, indent=2))
              exit(1)
          PYSCRIPT

      - name: Wait for health check
        if: steps.check_server.outputs.server_status == 'none'
        run: |
          IP=$(cat /tmp/server_ip.txt)
          echo "Waiting for dashboard at http://$IP:5000/api/health ..."
          echo "Polling every 5s, up to 180 attempts (15 min)..."
          echo ""

          for i in $(seq 1 180); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://$IP:5000/api/health" 2>/dev/null) || HTTP_CODE="000"
            if [ "$HTTP_CODE" = "200" ]; then
              echo ""
              echo "Dashboard is up! (attempt $i)"
              HEALTH=$(curl -s "http://$IP:5000/api/health")
              echo "Health response: $HEALTH"
              echo ""
              echo "========================================="
              echo "  DEPLOYMENT COMPLETE"
              echo "  IP: $IP"
              echo "  Dashboard: http://$IP:5000/"
              echo "  Screenshots: http://$IP:8080/"
              echo "========================================="
              exit 0
            fi

            # Every 30 attempts (~2.5 min), SSH in to check progress + fail fast
            if [ $((i % 30)) -eq 0 ]; then
              echo ""
              echo "--- SSH progress check (attempt $i) ---"
              CLOUD_STATUS=$(ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i /tmp/deploy_key root@$IP \
                "cloud-init status 2>/dev/null || echo 'unknown'" 2>/dev/null) || CLOUD_STATUS="ssh-failed"
              echo "cloud-init: $CLOUD_STATUS"

              ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i /tmp/deploy_key root@$IP \
                "tail -5 /var/log/bot-setup.log 2>/dev/null || echo '(no setup log yet)'" 2>/dev/null || true
              echo "---"
              echo ""

              # Fail fast: if cloud-init errored, no point waiting
              if echo "$CLOUD_STATUS" | grep -q "error"; then
                echo "FAIL FAST: cloud-init reported error. Dumping full setup log:"
                echo ""
                ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i /tmp/deploy_key root@$IP \
                  "cat /var/log/bot-setup.log 2>/dev/null; echo '==='; tail -30 /var/log/cloud-init-output.log 2>/dev/null" 2>/dev/null || true
                echo ""
                exit 1
              fi
            fi

            # Only print every 10th attempt to reduce noise
            if [ $((i % 10)) -eq 0 ]; then
              echo "  Attempt $i/180 — HTTP $HTTP_CODE, waiting..."
            fi
            sleep 5
          done

          echo ""
          echo "ERROR: Dashboard did not come up within 15 minutes."
          exit 1

      - name: Diagnose failure
        if: failure()
        run: |
          IP=$(cat /tmp/server_ip.txt 2>/dev/null) || { echo "No server IP found."; exit 0; }
          echo "========================================="
          echo "  DEPLOYMENT FAILED — DIAGNOSTICS"
          echo "  Server IP: $IP"
          echo "========================================="
          echo ""

          SSH_CMD="ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i /tmp/deploy_key root@$IP"

          echo "=== cloud-init status ==="
          $SSH_CMD "cloud-init status --long" 2>/dev/null || echo "(Could not connect via SSH)"
          echo ""

          echo "=== Bot setup log ==="
          $SSH_CMD "cat /var/log/bot-setup.log" 2>/dev/null || echo "(Log not available)"
          echo ""

          echo "=== cloud-init output log (last 80 lines) ==="
          $SSH_CMD "tail -80 /var/log/cloud-init-output.log" 2>/dev/null || echo "(Log not available)"
          echo ""

          echo "=== systemctl status satora-dashboard ==="
          $SSH_CMD "systemctl status satora-dashboard" 2>/dev/null || echo "(Service not found)"
          echo ""

          echo "=== journalctl satora-dashboard (last 30 lines) ==="
          $SSH_CMD "journalctl -u satora-dashboard --no-pager -n 30" 2>/dev/null || echo "(No logs)"
          echo ""

          echo "=== systemctl status satora-bot ==="
          $SSH_CMD "systemctl status satora-bot" 2>/dev/null || echo "(Service not found)"
          echo ""

          echo "=== Listening ports ==="
          $SSH_CMD "ss -tlnp" 2>/dev/null || echo "(Could not check)"

      - name: Cleanup SSH key from Hetzner
        if: always()
        run: |
          SSH_KEY_ID=$(cat /tmp/ssh_key_id.txt 2>/dev/null) || exit 0
          echo "Cleaning up deploy-tmp SSH key (ID: $SSH_KEY_ID)..."
          curl -sf -X DELETE \
            -H "Authorization: Bearer $HETZNER_TOKEN" \
            "https://api.hetzner.cloud/v1/ssh_keys/$SSH_KEY_ID" || true
