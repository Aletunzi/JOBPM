name: Test Agent

on:
  workflow_dispatch:
    inputs:
      action:
        description: "What to test"
        required: true
        default: "health"
        type: choice
        options:
          - health
          - run-once
          - full

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      HETZNER_TOKEN: ${{ secrets.HETZNER_API_TOKEN }}
      WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
    steps:
      - name: Get server IP
        run: |
          RESPONSE=$(curl -s -H "Authorization: Bearer $HETZNER_TOKEN" \
            https://api.hetzner.cloud/v1/servers)
          IP=$(echo "$RESPONSE" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          servers = data.get('servers', [])
          if not servers:
              print('NO_SERVER')
          else:
              print(servers[0]['public_net']['ipv4']['ip'])
          ")
          if [ "$IP" = "NO_SERVER" ]; then
            echo "ERROR: No server found. Run the deploy workflow first."
            exit 1
          fi
          echo "SERVER_IP=$IP" >> $GITHUB_ENV
          echo "Server IP: $IP"

      - name: Health check
        run: |
          echo "Checking http://$SERVER_IP:5000/api/health ..."
          HEALTH=$(curl -sf "http://$SERVER_IP:5000/api/health" 2>&1) || {
            echo "ERROR: Dashboard not responding"
            exit 1
          }
          echo "$HEALTH" | python3 -m json.tool
          echo ""
          echo "Dashboard is healthy."

      - name: Trigger run-once session
        if: inputs.action == 'run-once' || inputs.action == 'full'
        run: |
          echo "Triggering run-once session..."
          RESPONSE=$(curl -sf -X POST \
            "http://$SERVER_IP:5000/api/run-once?secret=$WEBHOOK_SECRET" 2>&1) || {
            echo "ERROR: Failed to trigger session"
            echo "$RESPONSE"
            exit 1
          }
          echo "$RESPONSE" | python3 -m json.tool
          echo ""
          echo "Session triggered. Waiting for completion..."

          # Poll for completion (max 15 minutes)
          for i in $(seq 1 60); do
            sleep 15
            STATUS=$(curl -sf "http://$SERVER_IP:5000/api/run-once/status" 2>/dev/null || echo '{"status":"error"}')
            CURRENT=$(echo "$STATUS" | python3 -c "import json,sys; print(json.load(sys.stdin).get('status','unknown'))")

            if [ "$CURRENT" = "finished" ]; then
              EXIT_CODE=$(echo "$STATUS" | python3 -c "import json,sys; print(json.load(sys.stdin).get('exit_code','?'))")
              echo "Session finished (exit code: $EXIT_CODE)"
              if [ "$EXIT_CODE" != "0" ]; then
                echo "WARNING: Session exited with non-zero code"
              fi
              break
            fi
            echo "  [$i/60] Status: $CURRENT â€” waiting 15s..."
          done

      - name: Check session results
        if: inputs.action == 'full'
        run: |
          echo "=== Latest session data ==="
          curl -sf "http://$SERVER_IP:5000/api/stats" | python3 -m json.tool
          echo ""
          echo "=== Daily summary ==="
          curl -sf "http://$SERVER_IP:5000/api/daily-summary" | python3 -m json.tool

      - name: Summary
        run: |
          echo ""
          echo "========================================="
          echo "  TEST COMPLETE"
          echo "  Server: $SERVER_IP"
          echo "  Dashboard: http://$SERVER_IP:5000/"
          echo "  Screenshots: http://$SERVER_IP:8080/"
          echo "========================================="
